---
title: ST-3 Oil Production Data
author: Andrew Leach
date: <p>`r format(Sys.time(), '%B, %Y')`</p>
output:
  html_document:
      code_folding: hide
      includes:
      after_body: 
      theme: lumen
  always_allow_html: yes
editor: source
---

The Alberta Energy Regulator (AER) provides monthly data for oil production in Alberta, including from the oil sands region in a report known as the ST-3.  The data are available [here](https://www.aer.ca/providing-information/data-and-reports/statistical-reports/st3), and you can either download the data and analyze it yourself or use the embedded R code below to download all the data. 

This page is also an easy introduction for downloading and manipulating data in R. If you're going to run the R code, you'll need a few basic set-up elements to get everything to work. I've included the code here for your reference.

```{r basics, cache=FALSE,warning=FALSE,message=FALSE}
#packages used
library(tidyverse) #basic set of data wrangling tools from the best part of the R universe
library(readxl) #it does what it says
library(scales) #makes graphs nicer
library(lubridate) #makes dates easier to handle
library(knitr) #using this to make the html document
library(prettydoc) #nice tables in the html doc
library(zoo) #time series data
library(viridis) #color-blind friendly palettes for graphs
library(patchwork) #allows you to combine plots
library(kableExtra) #nice tables in R Markdown
library(curl) #use this for checking internet connections
library(roll) #rolling means 
library(ggsci)
library(cowplot)

#unit conversions
m3_bbl<-function(x) x*6.2898
bbl_m3<-function(x) x/6.2898


#create tableau palettes 

colors_tableau10 <- function()
{
  return(c("#1F77B4", "#FF7F0E", "#2CA02C", "#D62728", "#9467BD", "#8C564B",
           "#E377C2", "#7F7F7F", "#BCBD22", "#17BECF"))
}

colors_tableau10_light <- function()
{
  return(c("#AEC7E8", "#FFBB78", "#98DF8A", "#FF9896", "#C5B0D5", "#C49C94",
           "#F7B6D2", "#C7C7C7", "#DBDB8D", "#9EDAE5"))
}

colors_tableau10_medium <- function()
{
  return(c("#729ECE", "#FF9E4A", "#67BF5C", "#ED665D", "#AD8BC9", "#A8786E",
           "#ED97CA", "#A2A2A2", "#CDCC5D", "#6DCCDA"))
}
#basic graph theme
weekly_small<-function(caption_align=1){
  theme_minimal()+theme(
    plot.margin = margin(.25, .75, .25, .75, "cm"),
    legend.position = "bottom",
    legend.margin=margin(c(0,0,0,0),unit="cm"),
    legend.text = element_text(colour="black", size = 9),
    plot.caption = element_text(size = 9, face = "italic",hjust=caption_align),
    plot.title = element_text(size = 12,face = "bold"),
    plot.subtitle = element_text(size = 11, face = "italic"),
    panel.grid.minor = element_blank(),
    text = element_text(size = 11,face = "bold"),
    axis.title.x = element_text(size = 11,face = "bold", colour="black",margin = margin(t = 15, b = 0)),
    axis.text = element_text(size = 11,face = "bold", colour="black",margin = margin(t = 10, b = 10)),
  )
}

```

# Download the Data

Once you've got the preliminaries of the code, downloading the data is fairly easy.  Each of the data files are stored by year, with the exception of the current year which has a different naming convention.  The first step is to access the data (click on the code button to see how to do things in R if you're interested).  The code also includes some fixes for names of projects which are not consistent in the data.  This is basically a trial and error process to find broken data series.

```{r st3_data, cache=FALSE,warning=FALSE,message=FALSE} 
#I'm going to make a function here so that I can specify whether I want to download all/none/new

st_3_online<-
download<-"all"
data_store <- list()
years<-seq(2010,2016)
i<-1
  filename<-paste("Gas_2010-2016.xlsx",sep="")
  if(tolower(download)=="all")#if you chose to download the old data. correct case errors in case someone sends "ALL"
        if(has_internet()) #if you're connected, go get the file
          if(!file.exists(filename))
          download.file(paste("https://www.aer.ca/documents/sts/st3/",filename,sep=""),filename,mode="wb")
#year<-2010 #testing
for(year in years){ #loop over 2010-2016, but the data are stored in different sheets
  production_data <- read_excel(filename, sheet = as.character(year), skip = 4)
  #the sheets are a bit of a mess, so we need to clean them up
  names(production_data)[1]<-"product" #name column 1
  # the %>% or pipeline is basically a  "pass to" command
  # start with production data, pass to select and remove cols 2 and 15, pass to filter and keep and rows with
  # the names in the keep_rows object we created above
  production_data<-production_data %>% select(-2,-15)%>% #%>% filter(product %in% keep_rows)
  filter(!is.na(product),!is.na(Jan))%>%
  mutate(across(-1, as.numeric))
  #rename the column with the annual data s (grep is a search function that, in this case, is looking for
  #whatever year we're processing and it will name the column annual
  names(production_data)[grep(as.character(year),names(production_data))]<-"annual"
  #assign the year to whatver year we're processing
  production_data$year<-year
  # create a long-form data set that will have product, annual level for that product, the year we're processing, and     #the monthly data
  production_data<-production_data %>% pivot_longer(cols=-c("product","annual","year"),
                                            names_to="month",values_to = "production")
  #store those data in a node in the list
  data_store[[i]]<-production_data
  #step your list counter one unit
  i<-i+1
  }
  #let's get 2017-2020 data - same process, but they are in seperate files
  #https://static.aer.ca/prd/documents/sts/st3/ST3_2021-12_Oil.xlsx
  years<-seq(2017,2024)
  #year<-2023
  for(year in years){ #loop over 2017-2020
    filename<-paste("Gas_",year,".xlsx",sep="") #use paste to put the year into the filename
    if(year==2024)
        filename<-"ST3_Gas_2024.xlsx"
    if(year==2023)
        filename<-"ST3_2023-12_Gas.xlsx"
    if(year==2022)
        filename<-"ST3_2022-12_Gas.xlsx"
    if(year==2021)
        filename<-"ST3_2021-12_Gas.xlsx"
    if(tolower(download)=="all")#if you chose to download the old data. correct case errors in case someone sends "ALL"
        if(has_internet()) #if you're connected, go get the file
          if(!file.exists(filename))
            if(year!=2024)
            download.file(paste("https://www.aer.ca/documents/sts/st3/",filename,sep=""),filename,mode="wb")
    if(has_internet()) #if you're connected, go get the file
          if(!file.exists(filename))
            if(year==2024)
            download.file("https://www.aer.ca/2025-02/ST3_Gas_2024.xlsx",filename,mode="wb")
    production_data <- read_excel(filename, sheet = "Data", skip = 4)
    names(production_data)[1]<-"product"
    production_data<-production_data %>% select(-2,-15) %>% filter(!is.na(product),!is.na(Jan))%>%
  mutate(across(-1, as.numeric))
    names(production_data)[grep(as.character(year),names(production_data))]<-"annual"
    production_data$year<-year
    production_data<-production_data %>% pivot_longer(cols=-c("product","annual","year"),
                                              names_to="month",values_to = "production")
    data_store[[i]]<-production_data
    i<-i+1
  }
  #Most recent data are stored as "current"  
  year<-"Current"
  filename<-paste("Gas_current.xlsx",sep="")
  #check for interne
  if(has_internet()) #if you're connected, go get the file
          download.file(paste("https://www.aer.ca/documents/sts/st3/",filename,sep=""),filename,mode="wb")
  production_data <- read_excel(filename, sheet = "Data", skip = 4)
  year<-2025
  names(production_data)[1]<-"product"
  production_data<-production_data %>% select(-2,-15) %>% filter(!is.na(product),!is.na(Jan))%>%
  mutate(across(-1, as.numeric))
  names(production_data)[grep(as.character(year),names(production_data))]<-"annual"
  production_data$year<-year
  production_data<-production_data %>% pivot_longer(cols=-c("product","annual","year"),
                                              names_to="month",values_to = "production")
  production_data<-production_data %>% filter(production!=0)#keep only non-zero production
  data_store[[i]]<-production_data
  
  #now, stack all the elements stored in your list of data into a data frame
  gas_production<-do.call(rbind,data_store)
  #now, we'll manipulate the data. mutate is adding a column based on a calculation
  #so, all_production is all_prodcution passed to mutate, where the production variable is set to numeric
  #and we format the dates using ymd since that's the format in the spreadsheet
  # (remember, the lubridate package makes dates easy)
  gas_production<-gas_production %>% mutate(production=as.numeric(production),
                                            date=ymd(paste(year,as.character(month),1,sep="-")))
         
```

With the data downloaded and compiled into a single file, with annual and quarterly subfiles, we can graph some data.


```{r st3_graphs, cache=FALSE,warning=FALSE,message=FALSE}


gas_prod<-
  ggplot(filter(gas_production,year>=2015,product%in% c("Well Production","In Situ Well Production"))%>%
                    #mutate(product=fct_relevel(product,"Condensate Production"))
         I()
         )+
  geom_area(aes(date,production/days_in_month(date)/10^3,group=product,fill=product),color="black", size=0.5)+
  scale_fill_manual("",values = pal_jco()(10),guide = "legend")+
  #scale_fill_viridis("",discrete = T,option="F",direction = -1,end = .9)+
  scale_x_date(date_breaks = "1 year",date_labels =  "%Y",expand = c(0,0))+
  scale_y_continuous(expand = c(0,0),breaks=pretty_breaks())+
  #scale_colour_manual("",values=my_palette,guide = "legend")+
  #expand_limits(y=4.5)+
  expand_limits(x=Sys.Date())+
  theme_ps_grid()+
  #theme(legend.position = "none")+
  labs(y="Production (Million cubic meters per day)",x=NULL,
       title="Alberta Natural Gas Production",
       #subtitle="For Operators with Production above 25k bbl/d",
       caption=paste("Source: AER ST-3 data current to ",format.Date(max(gas_production$date),format = "%B, %Y")  ,", graph by @andrew_leach",sep=""))
gas_prod
#if you want to create a png in normal code, use this
ggsave(gas_prod,filename="gas_prod.png",width=12,height=6)
```

